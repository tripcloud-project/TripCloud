<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ğŸ“ ë‚´ íŒŒì¼ íƒìƒ‰ê¸°</title>
    <style>
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 16px;
        padding: 20px;
      }

      .item {
        width: 100%;
        aspect-ratio: 1 / 1;
        border: 1px solid #ccc;
        border-radius: 8px;
        text-align: center;
        font-size: 14px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .item img {
        max-width: 80%;
        max-height: 80%;
        margin: 0 auto;
        object-fit: cover;
      }

      .item .name {
        margin-top: 6px;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
      }
      body {
        font-family: sans-serif;
      }

      #fileList li {
        margin-bottom: 4px;
      }

      #fileList a {
        margin-right: 8px;
        cursor: pointer;
      }

      #imagePreview {
        max-width: 300px;
        display: block;
        margin-top: 10px;
      }

      table {
        border-collapse: collapse;
        margin-top: 10px;
      }

      td {
        padding: 4px 8px;
        border: 1px solid #ccc;
      }

      button {
        margin-left: 6px;
      }

      #breadcrumb a {
        text-decoration: underline;
        margin-right: 4px;
      }
    </style>
  </head>
  <body>
    <div id="loginform">
      <h2 id="formTitle">Login</h2>
      <form id="authForm">
        <label>Email: <input type="email" id="email" required /></label><br />
        <div id="nameField" style="display: none">
          <label>Name: <input type="text" id="name" /></label><br />
        </div>
        <label>Password: <input type="password" id="password" required /></label
        ><br />
        <div id="confirmPasswordField" style="display: none">
          <label
            >Confirm Password:
            <input type="password" id="confirmPassword" /></label
          ><br />
        </div>
        <button type="submit" id="submitBtn">Login</button>
      </form>
      <p id="toggleText">
        Don't have an account?
        <a href="#" id="toggleLink">Sign Up</a>
      </p>
      <p id="message"></p>
    </div>

    <h2>ğŸ“¤ íŒŒì¼ ë˜ëŠ” í´ë” ì—…ë¡œë“œ</h2>

    <h1>ì‚¬ì§„ ê²€ìƒ‰</h1>

    <form id="searchForm">
      <input
        type="text"
        id="keyword"
        name="keyword"
        placeholder="ê²€ìƒ‰ì–´ ì…ë ¥"
        required
      />
      <button type="submit">ê²€ìƒ‰</button>
    </form>
    <div id="results"></div>
    <!-- ğŸ”¹ ê°œë³„ íŒŒì¼ ì—…ë¡œë“œ -->
    <form
      id="uploadForm"
      enctype="multipart/form-data"
      method="post"
      action="/upload"
    >
      <label>íŒŒì¼ ì„ íƒ: <input type="file" name="files" multiple /> </label
      ><br />

      <!-- ğŸ”¹ ë””ë ‰í† ë¦¬ ì—…ë¡œë“œ -->
      <label
        >í´ë” ì„ íƒ:
        <input
          type="file"
          name="files"
          webkitdirectory
          directory
          multiple
        /> </label
      ><br />

      <input type="hidden" name="prefix" id="uploadPrefix" value="uploads/" />
      <button type="submit">ì—…ë¡œë“œ</button>
    </form>

    <button id="toggleTrashBtn">ğŸ—‘ï¸ íœ´ì§€í†µ ë³´ê¸°</button>
    <h1>ğŸ“‚ íŒŒì¼ íƒìƒ‰ê¸°</h1>
    <p><strong>ğŸ“Œ í˜„ì¬ ê²½ë¡œ:</strong> <span id="breadcrumb"></span></p>
    <p id="dirSize"></p>
    <div>
      <button id="downloadSelectedBtn">ğŸ“¥ ì„ íƒ ë‹¤ìš´ë¡œë“œ</button>
      <button id="softDeleteSelectedBtn">ğŸ—‘ï¸ ì„ íƒ ì‚­ì œ</button>
    </div>
    <div id="trashActions" style="display: none">
      <button id="restoreSelectedBtn">â™»ï¸ ì„ íƒ ë³µì›</button>
      <button id="hardDeleteSelectedBtn">ğŸ—‘ï¸ ì„ íƒ ì˜êµ¬ì‚­ì œ</button>
    </div>

    <ul id="fileList"></ul>
    <div id="fileGrid" class="grid"></div>
    <h2>ğŸ–¼ï¸ ë¯¸ë¦¬ë³´ê¸°</h2>
    <img id="imagePreview" />

    <h2>ğŸ§¾ ë©”íƒ€ë°ì´í„°</h2>
    <div id="metaInfo"></div>

    <script>
      // ì‚¬ì§„ ê²€ìƒ‰
      const form = document.getElementById("searchForm");
      const resultsDiv = document.getElementById("results");

      form.addEventListener("submit", async function (e) {
        e.preventDefault();

        const keyword = document.getElementById("keyword").value;

        try {
          const response = await fetch(
            `/api/v1/gallery/search?keyword=${encodeURIComponent(keyword)}`
          );
          if (!response.ok) throw new Error("ê²€ìƒ‰ ì‹¤íŒ¨");

          const photos = await response.json();

          // ê²°ê³¼ í‘œì‹œ
          resultsDiv.innerHTML =
            photos.result.length > 0
              ? photos.result
                  .map(
                    (p) =>
                      `<div><strong>${p.filename}</strong> (${p.s3Key})</div>`
                  )
                  .join("")
              : "<p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
        } catch (error) {
          resultsDiv.innerHTML = `<p style="color:red;">ì˜¤ë¥˜: ${error.message}</p>`;
        }
      });

      // ë””ë ‰í† ë¦¬
      let userPrefix = "/";
      let currentPrefix = userPrefix;

      function formatBytes(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      function renderBreadcrumb(prefix) {
        const container = document.getElementById("breadcrumb");
        container.innerHTML = "";

        // âœ… 1. "/" ë£¨íŠ¸ ì¶”ê°€
        const rootLink = document.createElement("a");
        rootLink.textContent = "/";
        rootLink.href = "#";
        rootLink.onclick = (e) => {
          e.preventDefault();
          loadDirectory(""); // ìµœìƒìœ„ ê²½ë¡œë¡œ ì´ë™
        };
        container.appendChild(rootLink);

        const parts = prefix.split("/").filter((p) => p); // ["uploads", "ì—¬í–‰", "2024"]
        let cumulative = "";

        parts.forEach((part, index) => {
          container.append(" > ");

          cumulative += part + "/";

          const link = document.createElement("a");
          link.textContent = part;
          link.href = "#";

          const localPrefix = cumulative; // âœ… ê° ë£¨í”„ë§ˆë‹¤ ê³ ì •ëœ ë³µì‚¬ë³¸
          link.onclick = (e) => {
            e.preventDefault();
            loadDirectory(localPrefix);
          };

          container.appendChild(link);
        });
      }

      // ì—…ë¡œë“œ í¼ ì œì¶œ ì‹œ í˜„ì¬ ê²½ë¡œì— ì—…ë¡œë“œ
      document
        .getElementById("uploadForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const formData = new FormData(this);
          formData.set("prefix", currentPrefix);
          fetch(`http://localhost:8080/api/v1/gallery/upload`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${localStorage.getItem("accessToken")}`,
            },
            body: formData,
          }).then((res) => {
            if (res.ok) {
              alert("ì—…ë¡œë“œ ì„±ê³µ!");
              document.querySelector('input[type="file"]').value = null;
              document.querySelector('input[type="file"]').value = null;
              loadDirectory(currentPrefix);
            } else {
              alert("ì—…ë¡œë“œ ì‹¤íŒ¨");
            }
          });
        });

      // ì´ˆê¸° ë¡œë”©
      loadDirectory(currentPrefix);

      function loadDirectory(prefix) {
        currentPrefix = prefix;
        document.getElementById("uploadPrefix").value = prefix;
        renderBreadcrumb(prefix);
        fetch(`/api/v1/gallery/list?prefix=${encodeURIComponent(prefix)}`, {
          method: "GET",
          headers: {
            Authorization: `Bearer ${localStorage.getItem("accessToken")}`,
            "Content-Type": "application/json",
          },
        })
          .then((res) => res.json())
          .then((data) => {
            const container = document.getElementById("fileList");
            container.innerHTML = "";

            const grid = document.getElementById("fileGrid");
            grid.innerHTML = "";

            // 1. ë””ë ‰í† ë¦¬ ë¨¼ì €
            data.result.directories.forEach((entry) => {
              const fullKey = data.result.prefix + entry.name;

              // grid UI
              const div = document.createElement("div");
              div.className = "item";
              div.innerHTML = `
    <img src="https://cdn-icons-png.flaticon.com/512/716/716784.png" alt="folder" />
    <div class="name">${entry.name.slice(0, -1)}</div>
  `;
              div.onclick = () => loadDirectory(fullKey);
              grid.appendChild(div);

              // list UI
              const li = document.createElement("li");
              const a = document.createElement("a");
              a.textContent = `${entry.name.slice(0, -1)} (${formatBytes(
                entry.size
              )})`;
              a.href = "#";
              a.onclick = (e) => {
                e.preventDefault();
                loadDirectory(fullKey);
              };

              // ë””ë ‰í† ë¦¬ ì´ë¦„ ë³€ê²½
              const renameBtn = document.createElement("button");
              renameBtn.textContent = "âœï¸ ì´ë¦„ ë³€ê²½";
              renameBtn.onclick = (e) => {
                e.stopPropagation();
                const originalName = entry.name.replace(/\/$/, "");
                const newName = prompt("ìƒˆ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”", originalName);
                if (newName && newName !== originalName) {
                  const newPrefix = data.result.prefix + newName + "/";
                  fetch("/api/v1/gallery/rename", {
                    method: "PUT",
                    headers: {
                      Authorization: `Bearer ${localStorage.getItem(
                        "accessToken"
                      )}`,
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                      oldPrefix: fullKey,
                      newPrefix: newPrefix,
                    }),
                  }).then((res) => {
                    if (res.ok) {
                      alert("ì´ë¦„ ë³€ê²½ ì„±ê³µ!");
                      loadDirectory(currentPrefix);
                    } else {
                      alert("ì´ë¦„ ë³€ê²½ ì‹¤íŒ¨");
                    }
                  });
                }
              };

              const checkbox = document.createElement("input");
              checkbox.type = "checkbox";
              checkbox.className = "entryCheckbox";
              checkbox.dataset.key = fullKey;
              checkbox.dataset.type = "directory";

              li.prepend(checkbox);
              li.appendChild(a);
              li.appendChild(renameBtn);

              container.appendChild(li);
            });

            // 2. íŒŒì¼ë“¤
            data.result.files.forEach((entry) => {
              const fullKey = data.result.prefix + entry.name;

              const div = document.createElement("div");
              div.className = "item";
              div.innerHTML = `
    <img src="${entry.presignedUrl}" alt="image" />
    <div class="name">${entry.name}</div>
  `;
              div.onclick = () => fetchMetadata(entry.photoId);
              grid.appendChild(div);

              const li = document.createElement("li");
              const a = document.createElement("a");
              a.textContent = `${entry.name} (${formatBytes(entry.size)})`;
              a.href = "#";
              a.onclick = (e) => {
                e.preventDefault();
                fetchMetadata(entry.photoId);
              };

              // íŒŒì¼ ì´ë¦„ ë³€ê²½
              const renameBtn = document.createElement("button");
              renameBtn.textContent = "âœï¸ ì´ë¦„ ë³€ê²½";
              renameBtn.onclick = (e) => {
                e.stopPropagation();
                const originalName = entry.name;
                const dotIndex = originalName.lastIndexOf(".");
                const baseName = originalName.substring(0, dotIndex);
                const extension = originalName.substring(dotIndex);
                const newName = prompt("ìƒˆ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”", baseName);
                if (newName && newName !== baseName) {
                  const filename = newName + extension;
                  fetch(`/api/v1/gallery/rename/${entry.photoId}`, {
                    method: "PUT",
                    headers: {
                      Authorization: `Bearer ${localStorage.getItem(
                        "accessToken"
                      )}`,
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                      filename: filename,
                    }),
                  }).then((res) => {
                    if (res.ok) {
                      alert("ì´ë¦„ ë³€ê²½ ì„±ê³µ!");
                      loadDirectory(currentPrefix);
                    } else {
                      alert("ì´ë¦„ ë³€ê²½ ì‹¤íŒ¨");
                    }
                  });
                }
              };

              const checkbox = document.createElement("input");
              checkbox.type = "checkbox";
              checkbox.className = "entryCheckbox";
              checkbox.dataset.key = fullKey;
              checkbox.dataset.type = "file";
              checkbox.dataset.photoId = entry.photoId;

              li.prepend(checkbox);
              li.appendChild(a);
              li.appendChild(renameBtn);
              container.appendChild(li);
            });

            // ë””ë ‰í† ë¦¬ í¬ê¸° í‘œì‹œ
            document.getElementById("dirSize").innerText =
              "ì´ ìš©ëŸ‰: " + formatBytes(data.result.totalSize);
          });
      }
      let isTrashView = false;

      document
        .getElementById("toggleTrashBtn")
        .addEventListener("click", () => {
          if (!isTrashView) {
            // const userPrefix = userPrefix; // ì˜ˆ: "user1/"
            fetch(`/api/v1/gallery/trash/list`, {
              method: "GET",
              headers: {
                Authorization: `Bearer ${localStorage.getItem("accessToken")}`,
                "Content-Type": "application/json",
              },
            })
              .then((res) => res.json())
              .then((data) => {
                isTrashView = true;
                document.getElementById("toggleTrashBtn").textContent =
                  "ğŸ“ ì¼ë°˜ ë³´ê¸°";
                renderFileList(data, true); // íœ´ì§€í†µ í‘œì‹œ ëª¨ë“œ
              });
          } else {
            isTrashView = false;
            document.getElementById("toggleTrashBtn").textContent =
              "ğŸ—‘ï¸ íœ´ì§€í†µ ë³´ê¸°";
            loadDirectory(currentPrefix); // ì¼ë°˜ ë³´ê¸°ë¡œ ë³µì›
          }
        });

      // íœ´ì§€í†µ ë³´ê¸°
      function renderFileList(data, isTrash = false) {
        const container = document.getElementById("fileList");
        container.innerHTML = "";

        // íœ´ì§€í†µ ëª¨ë“œì¼ ë•Œë§Œ ë³µì›/ì‚­ì œ ë²„íŠ¼ ë³´ì—¬ì¤Œ
        document.getElementById("trashActions").style.display = isTrash
          ? "block"
          : "none";

        [...data.result.directories, ...data.result.files].forEach((entry) => {
          const li = document.createElement("li");
          const a = document.createElement("a");
          const fullKey = data.result.prefix + entry.name;

          a.textContent = `${entry.name} (${formatBytes(entry.size)})`;
          a.href = "#";
          a.onclick = (e) => {
            e.preventDefault();
            if (!entry.photoId) {
              if (isTrash) {
                alert("ğŸ“ ë””ë ‰í† ë¦¬ëŠ” ë³µì› í›„ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
              } else {
                loadDirectory(fullKey);
              }
            } else {
              if (isTrash) {
                alert("ğŸ–¼ï¸ ì‚­ì œëœ íŒŒì¼ì…ë‹ˆë‹¤. ë³µì› í›„ ì—´ëŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
              } else {
                fetchMetadata(entry.photoId);
              }
            }
          };

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.className = "entryCheckbox";
          checkbox.dataset.key = fullKey;

          if (entry.photoId) {
            checkbox.dataset.type = "file";
            checkbox.dataset.photoId = entry.photoId;
          } else {
            checkbox.dataset.type = "directory";
          }

          li.prepend(checkbox);
          li.appendChild(a);
          container.appendChild(li);
        });

        const grid = document.getElementById("fileGrid");
        grid.innerHTML = ""; // grid ì´ˆê¸°í™”

        [...data.result.directories, ...data.result.files].forEach((entry) => {
          // ... ê¸°ì¡´ ë¦¬ìŠ¤íŠ¸ UI êµ¬ì„± ì½”ë“œ

          // âœ… gridì—ë„ ì¶”ê°€
          const div = document.createElement("div");
          div.className = "item";
          div.onclick = (e) => {
            e.preventDefault();
            if (!entry.photoId) {
              if (isTrash) {
                alert("ğŸ“ ë””ë ‰í† ë¦¬ëŠ” ë³µì› í›„ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
              } else {
                loadDirectory(fullKey);
              }
            } else {
              if (isTrash) {
                alert("ğŸ–¼ï¸ ì‚­ì œëœ íŒŒì¼ì…ë‹ˆë‹¤. ë³µì› í›„ ì—´ëŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
              } else {
                fetchMetadata(entry.photoId);
              }
            }
          };

          if (entry.photoId) {
            div.innerHTML = `
      <img src="${entry.presignedUrl}" alt="image" />
      <div class="name">${entry.name}</div>
    `;
          } else {
            div.innerHTML = `
      <img src="https://cdn-icons-png.flaticon.com/512/716/716784.png" alt="folder" />
      <div class="name">${entry.name.slice(0, -1)}</div>
    `;
          }

          grid.appendChild(div);
        });

        document.getElementById("dirSize").innerText =
          "ì´ ìš©ëŸ‰: " + formatBytes(data.result.totalSize);
      }

      function fetchMetadata(photoId) {
        fetch(`/api/v1/gallery/detail/${photoId}`, {
          method: "GET",
          headers: {
            Authorization: `Bearer ${localStorage.getItem("accessToken")}`,
            "Content-Type": "application/json",
          },
        })
          .then((res) => res.json())
          .then((meta) => {
            const labels = {
              key: "íŒŒì¼ ê²½ë¡œ",
              size: "íŒŒì¼ í¬ê¸°",
              contentType: "íŒŒì¼ ìœ í˜•",
              lastModified: "ìµœì¢… ìˆ˜ì •ì¼",
              etag: "ETag",
              storageClass: "ì €ì¥ í´ë˜ìŠ¤",
            };

            const html = Object.entries(meta.result)
              .map(([k, v]) => {
                const label = labels[k] || k;
                const value = k === "size" ? formatBytes(v) : v;
                return `<tr><td><strong>${label}</strong></td><td>${value}</td></tr>`;
              })
              .join("");

            document.getElementById(
              "metaInfo"
            ).innerHTML = `<table>${html}</table>`;
          })
          .catch((err) => {
            document.getElementById("metaInfo").innerHTML =
              "ğŸ“› ë©”íƒ€ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + err.message;
          });
      }

      // ë¡œê·¸ì¸
      let isLogin = true;

      const formTitle = document.getElementById("formTitle");
      const nameField = document.getElementById("nameField");
      const confirmPasswordField = document.getElementById(
        "confirmPasswordField"
      );
      const submitBtn = document.getElementById("submitBtn");
      const toggleLink = document.getElementById("toggleLink");
      const message = document.getElementById("message");

      toggleLink.addEventListener("click", function (e) {
        e.preventDefault();
        isLogin = !isLogin;

        formTitle.textContent = isLogin ? "Login" : "Sign Up";
        submitBtn.textContent = isLogin ? "Login" : "Sign Up";
        toggleLink.textContent = isLogin ? "Sign Up" : "Login";
        document.getElementById("toggleText").childNodes[0].textContent =
          isLogin ? "Don't have an account? " : "Already have an account? ";
        nameField.style.display = isLogin ? "none" : "block";
        confirmPasswordField.style.display = isLogin ? "none" : "block";
        message.textContent = "";
      });

      document
        .getElementById("authForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const email = document.getElementById("email").value;
          const password = document.getElementById("password").value;

          if (!isLogin) {
            const name = document.getElementById("name").value;
            const confirmPassword =
              document.getElementById("confirmPassword").value;

            if (password !== confirmPassword) {
              message.textContent = "âŒ Passwords do not match";
              return;
            }

            try {
              const res = await fetch("http://localhost:8080/api/v1/members", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email, password, name }), // ğŸ‘ˆ ì´ë¦„ í¬í•¨
              });

              const data = await res.json();
              if (!res.ok) throw new Error(data.message || "Sign up failed");

              message.textContent = "âœ… Sign up successful! Please log in.";
              toggleLink.click(); // ìë™ ë¡œê·¸ì¸ í™”ë©´ ì „í™˜
            } catch (err) {
              message.textContent = `âŒ ${err.message}`;
            }
          } else {
            try {
              const res = await fetch(
                "http://localhost:8080/api/v1/auth/login",
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ email, password }),
                }
              );

              const authHeader = res.headers.get("Authorization"); // "Bearer eyJ..."
              if (!authHeader || !authHeader.startsWith("Bearer ")) {
                throw new Error("í† í°ì´ ì‘ë‹µì— ì—†ìŠµë‹ˆë‹¤");
              }

              const accessToken = authHeader.split(" ")[1]; // Bearer ì œê±°
              console.log("ë¡œê·¸ì¸: " + accessToken);
              localStorage.setItem("accessToken", accessToken);
              message.textContent = "âœ… Login successful!";
            } catch (err) {
              message.textContent = `âŒ ${err.message}`;
            }
          }
        });

      // ë‹¤ìš´ë¡œë“œ
      document
        .getElementById("downloadSelectedBtn")
        .addEventListener("click", async () => {
          const { prefixList, photoIdList } = collectSelectedEntries();
          if (prefixList.length === 0 && photoIdList.length === 0)
            return alert("ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");

          try {
            const res = await fetch("/api/v1/gallery/download", {
              method: "POST",
              headers: {
                Authorization: `Bearer ${localStorage.getItem("accessToken")}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                prefixList,
                photoIdList,
                currentPrefix,
              }),
            });

            if (!res.ok) throw new Error("ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨");

            const blob = await res.blob();
            const contentDisposition = res.headers.get("Content-Disposition");
            let filename = "downloaded_file"; // ê¸°ë³¸ê°’ì„ zipì´ ì•„ë‹Œ ì¼ë°˜ ì´ë¦„ìœ¼ë¡œ
            if (contentDisposition) {
              const match = contentDisposition.match(/filename\*=UTF-8''(.+)/);
              if (match && match[1]) {
                filename = decodeURIComponent(match[1]);
              } else {
                // fallback: filename="..."
                const fallback = contentDisposition.match(/filename="([^"]+)"/);
                if (fallback && fallback[1]) {
                  filename = fallback[1];
                }
              }
            }

            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
          } catch (err) {
            alert("âŒ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: " + err.message);
          }
        });

      document
        .getElementById("softDeleteSelectedBtn")
        .addEventListener("click", () => {
          const { prefixList, photoIdList } = collectSelectedEntries();
          if (prefixList.length === 0 && photoIdList.length === 0)
            return alert("ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");
          if (!confirm("ì„ íƒí•œ í•­ëª©ì„ íœ´ì§€í†µìœ¼ë¡œ ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

          fetch(`/api/v1/gallery/trash`, {
            method: "DELETE",
            headers: {
              Authorization: `Bearer ${localStorage.getItem("accessToken")}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              prefixList,
              photoIdList,
            }),
          }).then((res) => {
            if (!res.ok) {
              alert("ì‚­ì œ ì‹¤íŒ¨");
            } else {
              alert("ì‚­ì œ ì„±ê³µ");
              loadDirectory(currentPrefix);
            }
          });
        });

      document
        .getElementById("restoreSelectedBtn")
        .addEventListener("click", () => {
          const { prefixList, photoIdList } = collectSelectedEntries();
          if (prefixList.length === 0 && photoIdList.length === 0)
            return alert("ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");

          fetch("/api/v1/gallery/trash/restore", {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${localStorage.getItem("accessToken")}`,
            },
            body: JSON.stringify({ prefixList, photoIdList }),
          }).then((res) => {
            if (res.ok) {
              alert("ë³µì› ì™„ë£Œ!");
              document.getElementById("toggleTrashBtn").click();
            } else {
              alert("ë³µì› ì‹¤íŒ¨");
            }
          });
        });

      document
        .getElementById("hardDeleteSelectedBtn")
        .addEventListener("click", () => {
          const { prefixList, photoIdList } = collectSelectedEntries();
          if (prefixList.length === 0 && photoIdList.length === 0)
            return alert("ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");
          if (!confirm("ì •ë§ë¡œ ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

          fetch("/api/v1/gallery/trash/delete", {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${localStorage.getItem("accessToken")}`,
            },
            body: JSON.stringify({ prefixList, photoIdList }),
          }).then((res) => {
            if (res.ok) {
              alert("ì‚­ì œ ì™„ë£Œ!");
              // âœ… íœ´ì§€í†µ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
              fetch("/api/v1/gallery/trash/list", {
                method: "GET",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${localStorage.getItem(
                    "accessToken"
                  )}`,
                },
              })
                .then((res) => res.json())
                .then((data) => {
                  isTrashView = true;
                  document.getElementById("toggleTrashBtn").textContent =
                    "ğŸ“ ì¼ë°˜ ë³´ê¸°";
                  renderFileList(data, true);
                });
            } else {
              alert("ì‚­ì œ ì‹¤íŒ¨");
            }
          });
        });

      function collectSelectedEntries() {
        const checkboxes = document.querySelectorAll(".entryCheckbox:checked");
        const prefixList = [];
        const photoIdList = [];

        checkboxes.forEach((checkbox) => {
          const type = checkbox.dataset.type;
          if (type === "directory") prefixList.push(checkbox.dataset.key);
          else photoIdList.push(checkbox.dataset.photoId);
        });

        return { prefixList, photoIdList };
      }
    </script>
  </body>
</html>
